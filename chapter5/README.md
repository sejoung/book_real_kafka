# 프로듀서의 내부 동작 원리와 구현
## 파티셔너
카프카의 토픽은 성능 향상을 위한 병렬 처리가 가능하도록 하기 위해 파티션으로 나뉘고 최소 하나 또는 둘 이상의 파티션으로 구성된다.
프로듀서는 어느 파티션으로 메시지를 보내야 할지 결정할때 사용하는것이 파티셔너 이다.

기본적으로 메시지의 키를 해시 처리해 파티션을 구하는 방식을 사용한다. 메시지의 키값이 동일하면 모두 같은 파티션으로 보내진다.

메시지 키를 통해서 전송하는 경우 관리자의 의도와는 다르게 파티션수를 늘리면 다른 파티션에 저장될수도 있다.

### 라운드 로빈 전략

메시지 키값은 필수값이 아니므로 키값이 없을수도 있는데 없으면 라운드 로빈 알고리즘을 사용해 프로듀서는 파티션을 선택한다.

배치처리를 할때 라운드 로빈 전략은 효율을 떨어뜨릴수도 있다. 파티션별로 대기를 하기 때문에 효율이 떨어질수도 있다.

### 스티키 파티셔닝 전략

라운드 로빈 전략에서 지연시간이 불필요하게 증가되는 비효율적인 전송을 개선하고자 2019년 출시된 2.4 버전부터는 스티키 파티셔닝 전략을 사용하게 된다.

스티키 파티셔닝이란 하나의 파티션에 레코드수를 먼제 채워서 카프카로 빠르게 배치 전송하는 전략이다.

## 프로듀서의 배치

프로듀서에서 처리량을 높이기 위해 배치 전송을 권장한다.

배치전송에 사용되는 옵션
* buffer.memory : 프로듀서의 버퍼메모리 옵션 기본적으로 32mb 이다. -> batch.size 보다 무조건 커야됨
* batch.size : 배치 전송을 위해 메시지들을 묶는 단위를 설정하는 배치 크기 옵션이다. 기본값은 16kb로 설정
* linger.ms : 배치 전송을 위해 버퍼 메모리에서 대기하는 메시들의 최대 대기시간을 설정하는 옵션 기본값은 0이다. 

배치 전송 방식은 단건의 메시지를 전송하는 것이 아니라 한번의 다량의 메시지를 묶어서 전송하는 방법이다. 

장점
* 불필요한 IO를 줄일수 있다.
* 카프카의 요청 수를 줄여주는 효과

장점이 많다고 무조건 배치 전송을 사용하는것이 아니라 카프카를 사용하는 목적에 따라 처리량을 높일지 아니면 지연 없는 전송을 해야 되나 선택해야 된다.

## 중복 없는 전송

카프카는 중복 없는 전송을 지원한다. (멱등성 전송)

메시지 시스템의 메시지 전송 방식
* at-least-once : 적어도 한 번 전송
* at-most-once : 최대한 한 번 전송
* exactly-once : 정확히 한 번 전송

카프카는 기본적으로 적어도 한번 방식으로 동작함

최대한 한번 전송은 메시지 유실이 있을수 있다.

정확히 한번 전송은 ACK를 받지 못하면 같은 메시지를 다시 전송하고 브로커는 메시지가 있음 저장하지 않고 다시 ACK를 전달 합니다. 그래서 정확히 한번 전송이 될수 있습니다.

| 프로듀서 옵션                               | 값    | 설명                                                                      |
|---------------------------------------|------|-------------------------------------------------------------------------|
| enable.idempotence                    | true | 프로듀서가 중복없는 전송을 허용할지 결정하는 옵션입니다. 기본값은 false                              |
| max.in.flight.requests.per.connection | 1~5  | ack를 받지 않은 상태에서 하나의 커넥션에서 보낼 수 있는 최대 요청 수입니다. 기본 값은 5이며 5 이하로 설정해야 합니다. |
| acks                                  | all  | ack 관련 옵션 all로 설정해야된다.                                                  |
 | retries                               | 5    | 0 보다 큰값으로 설정해야 된다                                                       |

producer.config 설정 값
```
enable.idempotence=true
max.in.flight.requests.per.connection=5
retries=5
acks=all
```

## 정확히 한번 전송

가장 이상적인 상황 모든 메시지가 정확히 한번만 처리해주는것을 원한다.
중복없는 전송은 정확히 한번 전송의 일부 기능
트렌젝션을 사용해서 정확히 한번 전송이 가능해짐

