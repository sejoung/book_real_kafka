# 카프카 운영과 모니터링

## 안정적인 운영을 위한 주키퍼와 카프카 구성

카프카는 안정적이다.

### 주키퍼 구성

주키퍼는 파티션과 브로커의 메타데이터를 저장하고 컨트롤러 서버를 선출하는 동작을 수행한다.

카프카에서 주키버 의존성을 제거 예정임 

#### 주키퍼 서버 수량

주키퍼는 기본적으로 쿼럼(quorum) 구성을 기반으로 동작하므로 반드시 홀수로 구성해야 된다. 최소 수량은 3이다.
3대 구성일때 주키퍼 장애 허용 대수는 1대 이며 5대 구성일때 2대까지 허용이된다.

#### 주키퍼 하드웨어

주키퍼는 높은 하드웨어 리소스를 요구하지 않는다. 물리적 메모리는 4~8GB 구성하고 디스크는 240G또는 480G SSD 사용을 추천함

힙메모리 크기는 일반적으로 1~2GB 이다.

주키퍼는 트랜잭션이나 스냅샷 로그들을 로컬 디스크에 저장하는데 일반적은 SAS 디스크보다는 쓰기 성능이 좋은 SSD를 추천함

#### 주키퍼 배치

주키퍼는 각각 다른렉에 분산 배치하는것을 권장하며 이와 동시에 전원 이중화나 스위치 이중화도 고려해봐야 된다.

AWS 같은 경우 분산 배치를 위해 가용영역을 분리해서 분산 구성을 추천함

### 카프카 구성

#### 카프카 서버 수량

카프카는 주키퍼와 다르게 쿼럼 방식의 구성이 필요하지 않다. 
최소수량으로 구성하면 최소 2대도 가능하지만 카프카에서 추천하는 안정적인 리플리케이션 팩터수인 3을 구성하기 위해 3대의 브로커가 필요하다.

#### 카프카 하드웨어

주키퍼와 달리 CPU 사용률은 높은 편이다. 코어 수가 많은 CPU 구성을 권장함

카프카에서 요구하는 JVM 힙 사이즈는 일반적으로 6GB 정도이므로 이보다 큰 물리메모리가 필요하다.
힙사이즈를 제외한 나머지 물리메모리는 페이지캐시로 사용해서 어느정로 메모리 여유가 있어야 성능에 도움이 된다. 
128~256GB등 가용 메모리가 있으면 그대로 사용하고 최소 32GB이상 구성하는것을 추천한다.

디스크의 경우 성능이 가장 낮은 SATA 디스크를 선택해도 괜찮다.
낮은 성능의 디스크를 사용해도 높은 성능을 보장하는 이유가 로그 마지막에 순차적으로 쓰는 방식으로 로그를 기록하기 때문이다.
병렬처리를 위해 디스크 10개정도 장착하는게 좋다 토픽의 보관 주기를 충분하게 설정하려면 4TB 용량 이상을 사용하는것이 좋다.

NAS는 안정성 측면에서 사용하지 않는것을 권장한다.

카프카 네트워크 카드는 10G 이더넷 카드로 구성하는 것을 추천
브로커 한대당 네트워크 사용량 비율이 50%가 넘지 않도록 최대한 토픽을 분산해 운영해야 된다.

#### 카프카 배치

여러렉에 분산시켜 카프카 서버를 배치하는 방식을 추천함

AWS 같은 경우 분산 배치를 위해 가용영역을 분리해서 분산 구성을 추천함

## 모니터링 시스템 구성

### 애플리케이션으로서 카프카의 로그 관리와 분석

log4j.properties 파일을 수정해서 로그레벨을 수정할수 있다. 로그레벨을 수정하면 예상보다 많은 로그가 발생하여 브로커의 여유 디스크 공간이 사라질수도 있다.

### JMX를 이용한 카프카 메트릭 모니터링

프로메테우스 와 그라파나를 설치해서 성능 메트릭을 보게 구성한다.

## 그라파나와 프로메테우스 활용


